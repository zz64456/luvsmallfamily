{% extends 'auth/base_auth.html' %}
{% load static %}

{% block title %}ç™¼å¸ƒæ–°æ–‡ç«  - æœæ—¥è¨ˆç•«{% endblock %}
{% block subtitle %}åˆ†äº«æ‚¨çš„æ„›å¿ƒæ•…äº‹ï¼Œå¹«åŠ©æ›´å¤šæµæµªå‹•ç‰©{% endblock %}

{% block extra_css %}
<style>
    .form-textarea {
        width: 100%;
        padding: 15px;
        border: 2px solid hsl(var(--warm-orange) / 0.2);
        border-radius: 10px;
        font-size: 16px;
        font-family: inherit;
        resize: vertical;
        min-height: 150px;
        transition: border-color 0.3s ease;
    }
    
    .form-textarea:focus {
        outline: none;
        border-color: hsl(var(--warm-orange));
        box-shadow: 0 0 0 3px hsl(var(--warm-orange) / 0.1);
    }
    
    .file-upload-section {
        background: rgba(255,255,255,0.6);
        padding: 20px;
        border-radius: 15px;
        margin: 20px 0;
        border: 2px dashed hsl(var(--warm-orange) / 0.3);
        transition: all 0.3s ease;
    }
    
    .file-upload-section:hover {
        border-color: hsl(var(--warm-orange));
        background: rgba(255,255,255,0.8);
    }
    
    .form-file-input {
        width: 100%;
        padding: 12px;
        border: 1px solid hsl(var(--warm-orange) / 0.3);
        border-radius: 8px;
        background: white;
        cursor: pointer;
    }
    
    .preview-container {
        margin-top: 15px;
        display: none;
        background: white;
        padding: 15px;
        border-radius: 10px;
        border: 1px solid hsl(var(--warm-orange) / 0.2);
    }
    
    .preview-image {
        max-width: 100%;
        max-height: 300px;
        border-radius: 8px;
        object-fit: cover;
    }
    
    .preview-video {
        max-width: 100%;
        max-height: 300px;
        border-radius: 8px;
    }
    
    .file-info {
        margin-top: 10px;
        color: hsl(var(--text-medium));
        font-size: 0.9rem;
    }
    
    .remove-file-btn {
        background: hsl(0, 60%, 50%);
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 0.8rem;
        margin-top: 8px;
    }
    
    .remove-file-btn:hover {
        background: hsl(0, 70%, 45%);
    }
    
    .form-errors {
        background: hsl(0, 60%, 95%);
        color: hsl(0, 60%, 40%);
        padding: 10px;
        border-radius: 8px;
        margin: 10px 0;
        border-left: 4px solid hsl(0, 60%, 50%);
    }
    
    .help-text {
        color: hsl(var(--text-medium));
        font-size: 0.85rem;
        margin-top: 5px;
    }
</style>
{% endblock %}

{% block content %}
<form method="post" enctype="multipart/form-data" id="post-form">
    {% csrf_token %}
    
    {% if form.non_field_errors %}
        <div class="form-errors">
            {{ form.non_field_errors }}
        </div>
    {% endif %}
    
    <!-- æ¨™é¡Œæ¬„ä½ -->
    <div class="form-group">
        <label class="form-label" for="{{ form.title.id_for_label }}">
            ğŸ“ {{ form.title.label }}
        </label>
        {{ form.title }}
        {% if form.title.errors %}
            <div class="form-errors">{{ form.title.errors }}</div>
        {% endif %}
    </div>
    
    <!-- å…§å®¹æ¬„ä½ -->
    <div class="form-group">
        <label class="form-label" for="{{ form.text.id_for_label }}">
            ğŸ’­ {{ form.text.label }}
        </label>
        {{ form.text }}
        {% if form.text.errors %}
            <div class="form-errors">{{ form.text.errors }}</div>
        {% endif %}
    </div>
    
    <!-- åª’é«”ä¸Šå‚³å€åŸŸ -->
    <div class="file-upload-section">
        <h3 style="color: hsl(var(--warm-orange-dark)); margin-bottom: 15px; font-size: 1.1rem;">
            ğŸ“· æ·»åŠ åª’é«”æª”æ¡ˆï¼ˆé¸å¡«ï¼‰
        </h3>
        
        <!-- åœ–ç‰‡ä¸Šå‚³ -->
        <div class="form-group">
            <label class="form-label" for="{{ form.image.id_for_label }}">
                ğŸ–¼ï¸ {{ form.image.label }}
            </label>
            {{ form.image }}
            {% if form.image.help_text %}
                <div class="help-text">{{ form.image.help_text }}</div>
            {% endif %}
            {% if form.image.errors %}
                <div class="form-errors">{{ form.image.errors }}</div>
            {% endif %}
            <div id="image-preview" class="preview-container">
                <img id="preview-img" class="preview-image" src="" alt="åœ–ç‰‡é è¦½">
                <div class="file-info" id="image-info"></div>
                <button type="button" class="remove-file-btn" onclick="removeFile('image')">ç§»é™¤åœ–ç‰‡</button>
            </div>
        </div>
        
        <!-- å½±ç‰‡ä¸Šå‚³ -->
        <div class="form-group">
            <label class="form-label" for="{{ form.video.id_for_label }}">
                ğŸ¬ {{ form.video.label }}
            </label>
            {{ form.video }}
            {% if form.video.help_text %}
                <div class="help-text">{{ form.video.help_text }}</div>
            {% endif %}
            {% if form.video.errors %}
                <div class="form-errors">{{ form.video.errors }}</div>
            {% endif %}
            <div id="video-preview" class="preview-container">
                <video id="preview-video" class="preview-video" controls>
                    <source src="" type="">
                    æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´å½±ç‰‡æ’­æ”¾ã€‚
                </video>
                <div class="file-info" id="video-info"></div>
                <button type="button" class="remove-file-btn" onclick="removeFile('video')">ç§»é™¤å½±ç‰‡</button>
            </div>
        </div>
        
        <p style="color: hsl(var(--text-medium)); font-size: 0.9rem; margin-top: 15px;">
            ğŸ’¡ æç¤ºï¼šæ‚¨å¯ä»¥ä¸Šå‚³ä¸€å¼µåœ–ç‰‡æˆ–ä¸€å€‹å½±ç‰‡ï¼Œä½†ä¸èƒ½åŒæ™‚ä¸Šå‚³å…©ç¨®æª”æ¡ˆ
        </p>
    </div>
    
    <!-- æäº¤æŒ‰éˆ• -->
    <div style="display: flex; gap: 15px; margin-top: 30px;">
        <button type="submit" class="btn-primary" style="flex: 1;">
            ğŸš€ ç™¼å¸ƒæ–‡ç« 
        </button>
        <a href="{% url 'auth:profile' %}" class="btn-primary" style="flex: 1; background: linear-gradient(135deg, hsl(var(--text-medium)) 0%, hsl(var(--text-dark)) 100%); text-align: center; text-decoration: none; display: flex; align-items: center; justify-content: center;">
            âŒ å–æ¶ˆ
        </a>
    </div>
</form>

<div class="auth-links" style="margin-top: 30px;">
    <a href="{% url 'blog:blog_list' %}">â† è¿”å›é¦–é </a>
    <span style="margin: 0 15px;">|</span>
    <a href="{% url 'auth:profile' %}">å€‹äººè³‡æ–™</a>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const imageInput = document.getElementById('image-upload');
    const videoInput = document.getElementById('video-upload');
    const imagePreview = document.getElementById('image-preview');
    const videoPreview = document.getElementById('video-preview');
    
    // åœ–ç‰‡é è¦½åŠŸèƒ½
    imageInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            // æ¸…é™¤å½±ç‰‡é¸æ“‡
            videoInput.value = '';
            videoPreview.style.display = 'none';
            
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('preview-img').src = e.target.result;
                document.getElementById('image-info').textContent = 
                    `æª”æ¡ˆåç¨±: ${file.name} | å¤§å°: ${(file.size / 1024 / 1024).toFixed(2)} MB`;
                imagePreview.style.display = 'block';
            };
            reader.readAsDataURL(file);
        } else {
            imagePreview.style.display = 'none';
        }
    });
    
    // å½±ç‰‡é è¦½åŠŸèƒ½
    videoInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            // æ¸…é™¤åœ–ç‰‡é¸æ“‡
            imageInput.value = '';
            imagePreview.style.display = 'none';
            
            const videoUrl = URL.createObjectURL(file);
            const videoElement = document.getElementById('preview-video');
            const sourceElement = videoElement.querySelector('source');
            
            sourceElement.src = videoUrl;
            sourceElement.type = file.type;
            videoElement.load();
            
            document.getElementById('video-info').textContent = 
                `æª”æ¡ˆåç¨±: ${file.name} | å¤§å°: ${(file.size / 1024 / 1024).toFixed(2)} MB`;
            videoPreview.style.display = 'block';
        } else {
            videoPreview.style.display = 'none';
        }
    });
});

// ç§»é™¤æª”æ¡ˆåŠŸèƒ½
function removeFile(type) {
    if (type === 'image') {
        document.getElementById('image-upload').value = '';
        document.getElementById('image-preview').style.display = 'none';
    } else if (type === 'video') {
        document.getElementById('video-upload').value = '';
        document.getElementById('video-preview').style.display = 'none';
        // æ¸…ç†å½±ç‰‡ URL
        const videoElement = document.getElementById('preview-video');
        const sourceElement = videoElement.querySelector('source');
        URL.revokeObjectURL(sourceElement.src);
        sourceElement.src = '';
        videoElement.load();
    }
}

// è¡¨å–®æäº¤å‰é©—è­‰
document.getElementById('post-form').addEventListener('submit', function(e) {
    const title = document.querySelector('#id_title').value.trim();
    const text = document.querySelector('#id_text').value.trim();
    
    if (!title || !text) {
        e.preventDefault();
        alert('è«‹å¡«å¯«æ¨™é¡Œå’Œå…§å®¹ï¼');
        return false;
    }
    
    // é¡¯ç¤ºæäº¤ä¸­çš„ç‹€æ…‹
    const submitBtn = document.querySelector('button[type="submit"]');
    submitBtn.textContent = 'ğŸ“¤ ç™¼å¸ƒä¸­...';
    submitBtn.disabled = true;
});
</script>
{% endblock %}
